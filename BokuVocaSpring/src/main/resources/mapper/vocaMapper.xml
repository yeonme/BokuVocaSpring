<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.yeon.bokuvoca.words.dao.VocaMapper">
<select id="randomWord" resultType="word">
select
	num
	,yomi
    ,ifnull(word,'-') word
from
	jwords
where
    summary IS NOT NULL
order by
	RAND()
LIMIT 1
</select>
<select id="countWord" resultType="int">
select COUNT(*) from jwords
</select>
<select id="selectListWord" resultType="word" parameterType="String">
select
	num
	,word
	,yomi
	,jaro_winkler_similarity(#{keyword},yomi) ja
	,jlpt
	,star
from
	jwords
where
	(yomi like binary #{keyword}||'%'
	OR word like binary #{keyword}||'%')
order by
	ja desc
LIMIT 10
</select>
<select id="selectDetailWord" resultType="word" parameterType="int">
select
	*
from
	jwords
where
	num=#{num}
</select>
<select id="selectQWordAll" resultType="word">
select
	num
	,yomi
	,word
	,COALESCE(summary,meaning) summary
	,type
from
	jwords
where
	((summary IS NOT NULL)
	AND (word IS NOT NULL))
	AND (type IS NOT NULL)
order by
	RAND()
LIMIT 10
</select>
<select id="selectQWordJLPT" resultType="word" parameterType="String">
select
	num
	,yomi
	,word
	,COALESCE(summary,meaning) summary
	,type
from
	jwords
where
	((summary IS NOT NULL)
	AND (word IS NOT NULL))
       AND jlpt = #{value}
order by
	RAND()
LIMIT 10
</select>
<select id="selectQWordStar" resultType="word" parameterType="int">
select
		num
		,yomi
		,word
		,COALESCE(summary,meaning) summary
		,type
	from
		jwords
	where
		((summary IS NOT NULL)
		AND (word IS NOT NULL))
        AND star = #{value}
        AND (type IS NOT NULL)
	order by
		RAND()
LIMIT
	10
</select>
<select id="selectQWordVoca" resultType="word" parameterType="String">
select
	jw.num
	,jw.yomi
	,jw.word
	,COALESCE(jw.summary,jw.meaning) summary
	,jw.type
	,COALESCE(jv.remembered,STR_TO_DATE('19000101000000','%Y%m%d%H%I%S')) REMD
from
	jvoca jv, jwords jw
where
	jv.vnum = jw.num AND
	((jw.summary IS NOT NULL)
	AND (jw.word IS NOT NULL))
	AND jv.owner = #{value}
order by
	REMD asc
LIMIT
	10
</select>
<select id="listYomiByLength" parameterType="hashmap" resultType="word">
select
	distinct binary yomi yomi
	<if test="!legacy">
	,jaro_winkler_similarity(binary yomi, binary #{answer}) ja
	</if>
from
	jwords
where
	<if test="!legacy">
	type=#{type} AND
	</if>
	<if test="!legacy and okuri == null">
    binary yomi LIKE CONCAT(binary #{startswith},'%') AND 
    </if>
	char_length(yomi)=#{length}
	AND binary yomi!=binary #{answer}
	<if test="!legacy and okuri != null">
	AND binary yomi LIKE CONCAT('%',binary #{okuri})
	</if>
order by
	<if test="legacy">
	RAND()
	</if>
	<if test="!legacy">
	ja desc
	</if>
LIMIT 4
</select>
<select id="listKanjiByLength" parameterType="hashmap" resultType="word">
select
	distinct binary word word
	,yomi
	<if test="!legacy">
	,jaro_winkler_similarity(binary word, binary #{answer}) ja
	</if>
from
	jwords
where
	<if test="!legacy">
	type=#{type}
    AND binary yomi LIKE CONCAT(binary #{startswith},'%') AND
    </if>
	(char_length(yomi)=#{length} OR char_length(word)=#{wlength})
	AND binary word!=binary #{answer}
order by
	<if test="legacy">
	RAND()
	</if>
	<if test="!legacy">
	ja desc
	</if>
LIMIT 4
</select>
<update id="updateMemVoca" parameterType="int">
update
	jvoca
set
	remembered=NOW()
where
	vnum = #{value}
</update>

<select id="selectKanjiSimilar" resultType="word" parameterType="word">
select * from jwords
where
	yomi=binary #{yomi, jdbcType=VARCHAR}
	AND word like binary #{word, jdbcType=VARCHAR}
</select>



<select id="countVoca" resultType="int" parameterType="String">
select COUNT(*) from jvoca
where owner = #{value}
</select>
<select id="selectVoca" resultType="voca" parameterType="hashmap">
select
	jv.vnum "num"
    ,jw.word "word"
    ,jw.yomi "yomi"
    ,jw.type "type"
    ,jw.summary "summary"
    ,jv.inserted "added"
    ,jv.remembered "remembered"
    ,jv.owner "user"
from
	jvoca jv, jwords jw
where
	jv.owner = #{user}
       AND jv.vnum = jw.num
order by
	jv.inserted DESC
LIMIT #{startitem}, #{count}
</select>
<select id="hasVoca" resultType="voca" parameterType="voca">
select vnum num
from jvoca
where vnum = #{num} AND owner = #{user} 
</select>
<update id="newVoca" parameterType="voca">
INSERT INTO jvoca (vnum, owner) VALUES (#{num}, #{user})  
ON DUPLICATE KEY UPDATE vnum=#{num}, owner=#{user}
</update>
<update id="rememberVoca" parameterType="voca">
update
	jvoca
set
	remembered = NOW()
where
	vnum = #{voca}
	AND owner = #{user}
</update>
<delete id="deleteVoca" parameterType="voca">
delete from
	jvoca
where
	<if test="num != 0">
	vnum=#{num} AND
	</if>
	owner = #{user}
</delete>


<select id="selectUser" resultType="user">
select
	*
from
	jusers
order by
	username asc
</select>

<insert id="insertUser" parameterType="String">
insert into
	jusers
	(
		username
	)
values
	(
		#{value}
	)
</insert>
<delete id="deleteUser" parameterType="String">
delete from
	jusers
where username=#{value}
</delete>
</mapper>